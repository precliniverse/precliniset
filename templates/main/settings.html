{% extends "base.html" %}
{% import "_formhelpers.html" as forms %} {# Assuming _formhelpers.html exists for form rendering #}

{% block content %}
<div class="row">
    <div class="col-md-6 offset-md-3">
        <h2>{{ _(title) }}</h2>
        
        <hr>

        {# --- Change Password Form --- #}
        <h3>{{ _('Change Password') }}</h3>
        <form method="POST" action="{{ url_for('main.settings') }}" class="mb-4">
            {{ password_form.hidden_tag() }} {# CSRF for password form #}
            {{ forms.render_field(password_form.current_password, class="form-control") }}
            {{ forms.render_field(password_form.new_password, class="form-control") }}
            {{ forms.render_field(password_form.confirm_new_password, class="form-control") }}
            <div class="d-grid gap-2">
                {{ password_form.submit_password(class="btn btn-primary mt-3") }}
            </div>
        </form>

        <hr>

        {# --- Change Email Form --- #}
        <h3>{{ _('Change Email Address') }}</h3>
        <p>Current Email: {{ current_user.email }}</p>
        <form method="POST" action="{{ url_for('main.settings') }}">
            {{ email_form.hidden_tag() }} {# CSRF for email form #}
            {{ forms.render_field(email_form.new_email, class="form-control") }}
            {{ forms.render_field(email_form.current_password, class="form-control", placeholder=_("Enter current password to verify")) }}
            <div class="d-grid gap-2">
                {{ email_form.submit_email(class="btn btn-secondary mt-3") }}
            </div>
        </form>
        <small class="form-text text-muted">{{ _('A confirmation link will be sent to your new email address.') }}</small>

        <hr>

        {# --- Change Language Form --- #}
        <h3>{{ _('Language Settings') }}</h3>
        <form method="POST" action="{{ url_for('main.settings') }}">
            <input type="hidden" name="csrf_token" value="{{ csrf_token() }}"/>
            <div class="mb-3">
                <label for="language" class="form-label">{{ _('Select Language') }}</label>
                <select class="form-select" id="language" name="language">
                    {% for lang in current_app.config['LANGUAGES'] %}
                        <option value="{{ lang }}" {% if lang == current_language %}selected{% endif %}>
                            {# Simple display name mapping #}
                            {% if lang == 'en' %}English{% endif %}
                            {% if lang == 'fr' %}Fran√ßais{% endif %}
                            {# Add more languages here if needed #}
                        </option>
                    {% endfor %}
                </select>
            </div>
            <div class="d-grid gap-2">
                <button type="submit" name="submit_language" class="btn btn-info mt-3">{{ _('Save Language') }}</button>
            </div>
        </form>



        <hr>

        {# --- CKAN Settings Form --- #}
        <h3 id="ckan-settings-section">{{ _('CKAN Settings') }}</h3>
        <p class="text-muted small">{{ _('Enter the URL and your API Key for the CKAN portal you want to upload projects to.') }}</p>
        <form method="POST" action="{{ url_for('main.settings') }}" class="mb-4">
            {{ ckan_form.hidden_tag() }}
            <div class="mb-3">
                {{ ckan_form.ckan_url.label(class="form-label") }}
                {{ ckan_form.ckan_url(class="form-control") }}
                <div class="form-text">{{ ckan_form.ckan_url.description }}</div>
            </div>
            <div class="mb-3">
                {{ ckan_form.ckan_api_key.label(class="form-label") }}
                {{ ckan_form.ckan_api_key(class="form-control") }}
                <div class="form-text">{{ ckan_form.ckan_api_key.description }}</div>
            </div>
            <div class="d-grid gap-2">
                {{ ckan_form.submit_ckan_settings(class="btn btn-primary mt-3") }}
            </div>
        </form>
        
        <hr>
        <div>
            <hr>

            {# --- Calendar Subscription --- #}
            <h3 id="calendar-subscription-section">{{ _('Personal Calendar Subscription') }}</h3>
            <p class="text-muted small">{{ _('Use this URL to subscribe to a calendar feed of events assigned to you. Keep this URL private.') }}</p>
            {% if current_user.calendar_token %}
                <div class="input-group mb-3">
                    <input type="text" class="form-control" value="{{ url_for('calendar.personal_feed', user_id=current_user.id, token=current_user.calendar_token, _external=True) }}" readonly id="calendar-url-input">
                    <button class="btn btn-outline-secondary" type="button" id="copy-calendar-url-btn" title="{{ _('Copy to Clipboard') }}"><i class="fas fa-copy"></i></button>
                </div>
            {% else %}
                <p class="text-muted">{{ _('You have not generated a calendar URL yet.') }}</p>
            {% endif %}
            <form method="POST" action="{{ url_for('main.settings') }}">
                {{ calendar_token_form.hidden_tag() }}
                {{ calendar_token_form.submit_regenerate(class="btn btn-info btn-sm") }}
            </form>
            <h5 class="mt-4">{{ _('All Teams Calendar Subscription') }}</h5>
            <p class="text-muted small">{{ _('Use this URL to subscribe to a calendar feed of ALL events from ALL projects you have access to.') }}</p>
            {% if current_user.team_calendar_token %}
                <div class="input-group mb-3">
                    <input type="text" class="form-control" value="{{ url_for('calendar.team_feed', user_id=current_user.id, token=current_user.team_calendar_token, _external=True) }}" readonly id="team-calendar-url-input">
                    <button class="btn btn-outline-secondary" type="button" id="copy-team-calendar-url-btn" title="{{ _('Copy to Clipboard') }}"><i class="fas fa-copy"></i></button>
                </div>
            {% else %}
                <p class="text-muted">{{ _('You have not generated a team calendar URL yet.') }}</p>
            {% endif %}
            <form method="POST" action="{{ url_for('main.settings') }}">
                {{ team_calendar_token_form.hidden_tag() }}
                {{ team_calendar_token_form.submit_regenerate_team(class="btn btn-info btn-sm") }}
            </form>
    
            <hr>
            <hr>
            <h3 id="api-tokens-section">{{ _('API Token Management') }}</h3>
<p class="text-muted small">{{ _('API tokens allow external applications or scripts to access your Precliniset data programmatically.') }}</p>

{% if newly_generated_token %}
<div class="alert alert-warning">
    <strong>{{ _('Your New API Token:') }}</strong>
    <p class="font-monospace my-2 p-2 bg-body-tertiary border rounded" style="word-break: break-all;">{{ newly_generated_token }}</p>
    <p>{{ _('Please copy this token and store it securely. You will not be able to see it again.') }}</p>
</div>
{% endif %}

<div class="card mb-4">
    <div class="card-header">{{ _('Create New API Token') }}</div>
    <div class="card-body">
        <form method="POST" action="{{ url_for('main.settings') }}">
            {{ api_token_form.hidden_tag() }}
            <div class="mb-3">
                {{ api_token_form.name.label(class="form-label") }}
                {{ api_token_form.name(class="form-control" + (" is-invalid" if api_token_form.name.errors else "")) }}
                {% if api_token_form.name.errors %}
                    <div class="invalid-feedback">
                        {% for error in api_token_form.name.errors %}<span>{{ error }}</span>{% endfor %}
                    </div>
                {% endif %}
                <div class="form-text">{{ api_token_form.name.description }}</div>
            </div>
            {{ api_token_form.submit_create_token(class="btn btn-primary") }}
        </form>
    </div>
</div>

<h5>{{ _('Your API Tokens') }}</h5>
{% if user_api_tokens %}
    <div class="table-responsive">
        <table class="table table-striped table-sm">
            <thead>
                <tr>
                    <th>{{ _('Name') }}</th>
                    <th>{{ _('Token Prefix') }}</th>
                    <th>{{ _('Created At') }}</th>
                    <th>{{ _('Last Used') }}</th>
                    <th>{{ _('Status') }}</th>
                    <th>{{ _('Actions') }}</th>
                </tr>
            </thead>
            <tbody>
                {% for token in user_api_tokens %}
                <tr>
                    <td>{{ token.name }}</td>
                    <td><code>{{ token.prefix }}...</code></td>
                    <td>{{ token.created_at.strftime('%Y-%m-%d %H:%M') if token.created_at else 'N/A' }}</td>
                    <td>{{ token.last_used_at.strftime('%Y-%m-%d %H:%M') if token.last_used_at else 'Never' }}</td>
                    <td>
                        {% if token.is_active %}
                            <span class="badge bg-success">{{ _('Active') }}</span>
                        {% else %}
                            <span class="badge bg-danger">{{ _('Revoked') }}</span>
                        {% endif %}
                    </td>
                    <td>
                        {% if token.is_active %}
                        <form method="POST" action="{{ url_for('main.revoke_api_token', token_id=token.id) }}" class="confirm-revoke-token-form" data-confirm-message="{{ _('Are you sure you want to revoke this token? It will no longer be usable.') }}">
                            <input type="hidden" name="csrf_token" value="{{ csrf_token() }}"/>
                            <button type="submit" class="btn btn-danger btn-sm">{{ _('Revoke') }}</button>
                        </form>
                        {% else %}
                            <span class="text-muted">{{ _('Revoked') }}</span>
                        {% endif %}
                    </td>
                </tr>
                {% endfor %}
            </tbody>
        </table>
    </div>
{% else %}
    <p>{{ _('You have not created any API tokens yet.') }}</p>
{% endif %}

</div>

{# --- Test Email Form --- #}
<hr>
<div class="row">
    <div class="col-md-12">
        <h3>{{ _('Test Email Configuration') }}</h3>
        <p class="text-muted small">{{ _('Send a test email to verify that your SMTP settings in the .env file are correct.') }}</p>
        <form method="POST" action="{{ url_for('main.settings') }}" class="mb-4">
            {{ smtp_test_form.hidden_tag() }}
            {{ forms.render_field(smtp_test_form.test_email, class="form-control") }}
            <div class="form-text">{{ smtp_test_form.test_email.description }}</div>
            <div class="d-grid gap-2">
                {{ smtp_test_form.submit_test_email(class="btn btn-info mt-3") }}
            </div>
        </form>
    </div>
</div>
     </div>
 </div>
</div>
</div>
{% endblock %}

{% block scripts %}
{{ super() }}
<script nonce="{{ csp_nonce }}">
document.addEventListener('DOMContentLoaded', function() {
    document.querySelectorAll('.confirm-revoke-token-form').forEach(form => {
        form.addEventListener('submit', function(event) {
            const message = this.dataset.confirmMessage || 'Are you sure?';
            if (!confirm(message)) {
                event.preventDefault();
            }


        });
    });

    // ADD THIS NEW SCRIPT for calendar URL copy
    const copyBtn = document.getElementById('copy-calendar-url-btn');
    const urlInput = document.getElementById('calendar-url-input');
    const copyTeamBtn = document.getElementById('copy-team-calendar-url-btn');
    const teamUrlInput = document.getElementById('team-calendar-url-input');
    if (copyBtn && urlInput) {
        copyBtn.addEventListener('click', function() {
            urlInput.select();
            document.execCommand('copy');
            // Provide feedback
            const originalIcon = this.innerHTML;
            this.innerHTML = '<i class="fas fa-check"></i>';
            setTimeout(() => {
                this.innerHTML = originalIcon;
            }, 2000);
        });
    }
});
</script>
{% endblock %}
