{% extends 'base.html' %}
{% from "_formhelpers.html" import render_field %}

{% block title %}{{ _('Edit Data Table') }}{% endblock %}

{% block styles %}
{{ super() }}
<link href="https://cdn.jsdelivr.net/npm/select2@4.1.0-rc.0/dist/css/select2.min.css" rel="stylesheet" />
{% endblock %}


{% block content %}
<div class="d-flex justify-content-between align-items-start mb-3">
    <div>
        <h1 class="mb-0">{{ _('Edit Data Table') }}</h1>
        <div class="text-muted small mt-1 d-flex align-items-center flex-wrap gap-3">
             <span class="text-nowrap"><i class="fas fa-layer-group"></i> <strong>{{ _('Group') }}:</strong> <a href="{{ url_for('groups.edit_group', id=data_table.group.id) }}" class="text-decoration-none">{{ data_table.group.name }}</a></span>
             <span class="text-nowrap"><i class="fas fa-file-alt"></i> <strong>{{ _('Protocol') }}:</strong> <a href="{{ url_for('core_models.edit_model', model_type='protocol', id=data_table.protocol.id) }}" class="text-decoration-none">{{ data_table.protocol.name }}</a>
                <button type="button" class="btn btn-link btn-sm p-0 ms-1 text-info" data-bs-toggle="modal" data-bs-target="#protocolDetailsModal" title="{{ _('Details') }}">
                    <i class="fas fa-info-circle"></i>
                </button>
             </span>
             <span class="text-nowrap"><i class="fas fa-clipboard-check"></i> <strong>{{ _('EA') }}:</strong>
                {% if data_table.group.ethical_approval %}
                <a href="{{ url_for('ethical_approvals.create_edit_ethical_approval', ea_id=data_table.group.ethical_approval.id) }}" class="text-decoration-none">
                    {{ data_table.group.ethical_approval.reference_number }}
                </a>
                {% else %}
                <span class="text-muted">{{ _('N/A') }}</span>
                {% endif %}
            </span>
        </div>
    </div>

    <div class="d-flex flex-wrap gap-2 justify-content-end">
        <a href="{{ url_for('datatables.view_data_table', datatable_id=data_table.id) }}"
            class="btn btn-sm btn-info" title="{{ _('View') }}"><i class="fa-solid fa-eye"></i> {{
            _('View') }}</a>
        <a href="{{ url_for('datatables.analyze_datatable', datatable_id=data_table.id) }}"
            class="btn btn-sm btn-success" title="{{ _('Analyze') }}"><i class="fa-solid fa-chart-bar"></i> {{
            _('Analyze') }}</a>

        {% if data_table.group.randomization_details and (current_user.is_super_admin or
        check_group_permission(data_table.group, 'edit_exp_group')) %}
        <div class="btn-group">
            <a href="{{ url_for('datatables.download_data_table', id=data_table.id, blinding='blinded') }}"
                class="btn btn-sm btn-secondary" title="{{ _('Download Blinded XLSX') }}"><i
                    class="fas fa-file-download"></i> {{ _('Blinded') }}</a>
            <button type="button" class="btn btn-sm btn-secondary dropdown-toggle dropdown-toggle-split"
                data-bs-toggle="dropdown" aria-expanded="false">
                <span class="visually-hidden">Toggle Dropdown</span>
            </button>
            <ul class="dropdown-menu">
                <li><a class="dropdown-item"
                        href="{{ url_for('datatables.download_data_table', id=data_table.id, blinding='unblinded') }}">{{
                        _('Download Unblinded') }}</a></li>
            </ul>
        </div>
        {% else %}
        <a href="{{ url_for('datatables.download_data_table', id=data_table.id) }}"
            class="btn btn-sm btn-secondary" title="{{ _('Download XLSX') }}"><i class="fas fa-file-download"></i>
            {{ _('Download') }}</a>
        {% endif %}

        <a href="{{ url_for('datatables.download_transposed_data_table', id=data_table.id) }}"
            class="btn btn-sm btn-primary" title="{{ _('Download Transposed (Prism)') }}"><i
                class="fa-solid fa-rotate-right"></i> {{ _('Transpose') }}</a>

        {% if data_table not in current_user.my_page_datatables %}
        <form method="POST" action="{{ url_for('main.add_datatable_to_my_page', datatable_id=data_table.id) }}"
            style="display:inline;">
            <input type="hidden" name="csrf_token" value="{{ csrf_token() }}">
            <button type="submit" class="btn btn-sm btn-secondary" title="{{ _('Add to My Page') }}"><i
                    class="fas fa-bookmark"></i> {{ _('Pin') }}</button>
        </form>
        {% else %}
        <form method="POST" action="{{ url_for('main.remove_datatable_from_my_page', datatable_id=data_table.id) }}"
            style="display:inline;">
            <input type="hidden" name="csrf_token" value="{{ csrf_token() }}">
            <button type="submit" class="btn btn-sm btn-warning" title="{{ _('Remove from My Page') }}"><i
                    class="fas fa-bookmark"></i> {{ _('Unpin') }}</button>
        </form>
        {% endif %}

        {% if not is_read_only %}
        <form method="POST" action="{{ url_for('datatables.delete_data_table', id=data_table.id) }}"
            style="display:inline;" class="confirm-delete-form">
            <input type="hidden" name="csrf_token" value="{{ csrf_token() }}" />
            <button type="submit" class="btn btn-sm btn-danger" title="{{ _('Delete') }}"><i
                    class="fa-solid fa-trash"></i> {{ _('Delete') }}</button>
        </form>
        {% endif %}

        <a href="{{ url_for('datatables.list_group_datatables', group_id=data_table.group_id) }}"
            class="btn btn-sm btn-secondary"><i class="fas fa-arrow-left me-1"></i> {{ _('Back') }}</a>
    </div>
</div>

<div class="metadata-form-container p-3 mb-2 rounded bg-light border-0">
    <form method="POST" id="metadata-form">
        <input type="hidden" name="csrf_token" value="{{ csrf_token() }}" />
        <input type="hidden" name="update_metadata" value="true" />
        
        <div class="metadata-grid">
            <!-- Date -->
            <div class="metadata-field">
                 <label class="metadata-label">{{ _('Date') }}</label>
                 <div class="input-group input-group-sm">
                    <input type="date" name="date" class="form-control" value="{{ data_table.date }}">
                    <span class="input-group-text"><a href="{{ url_for('calendar.view_calendar', date=data_table.date) }}" title="{{ _('View on Calendar') }}" class="text-decoration-none"><i class="fas fa-calendar-alt"></i></a></span>
                </div>
            </div>
            
            <!-- Assigned To -->
            <div class="metadata-field">
                 <label class="metadata-label">{{ _('Assigned To') }}</label>
                 {{ assignee_and_housing_form.assigned_to_id(class="form-select form-select-sm") }}
            </div>
            
            <!-- Housing -->
            <div class="metadata-field">
                <label class="metadata-label">{{ _('Housing') }}</label>
                {{ assignee_and_housing_form.housing_condition_set_id(class="form-select form-select-sm") }}
            </div>
            
            <!-- Update Button -->
             <div class="metadata-field">
                 <label class="metadata-label metadata-label-spacer" aria-hidden="true">{{ _('Update Info') }}</label>
                <button type="submit" class="btn btn-primary btn-sm" title="{{_('Update Metadata')}}">
                    <i class="fas fa-save me-1"></i> {{ _('Update Info') }}
                </button>
            </div>
        </div>
    </form>
</div>

<style nonce="{{ csp_nonce }}">
    /* Metadata Form Grid Layout */
    .metadata-grid {
        display: grid;
        grid-template-columns: repeat(4, 1fr);
        gap: 0.5rem;
        align-items: end;
    }
    
    @media (max-width: 991px) {
        .metadata-grid {
            grid-template-columns: repeat(2, 1fr);
        }
    }
    
    @media (max-width: 767px) {
        .metadata-grid {
            grid-template-columns: 1fr;
        }
    }
    
    .metadata-field {
        display: flex;
        flex-direction: column;
        min-height: 52px; /* Compact: label (24px) + gap (4px) + input (31px) */
    }
    
    .metadata-label {
        font-size: 0.75rem;
        text-transform: uppercase;
        color: #6c757d;
        font-weight: 700;
        margin-bottom: 0.25rem;
        height: 1.5rem;
        line-height: 1.5rem;
        display: block;
    }
    
    .metadata-label-spacer {
        visibility: hidden;
    }
    
    /* Native select sizing before Select2 initialization */
    #metadata-form select.form-select-sm {
        height: 31px;
        padding: 0.25rem 2.25rem 0.25rem 0.5rem;
        font-size: 0.875rem;
        line-height: 1.5;
        box-sizing: border-box;
    }
    
    /* Select2 container - match native select exactly */
    #metadata-form .select2-container {
        width: 100% !important;
        height: 31px !important;
        max-height: 31px !important;
    }
    
    #metadata-form .select2-container .select2-selection--single {
        height: 31px !important;
        max-height: 31px !important;
        min-height: 31px !important;
        border: 1px solid #ced4da;
        border-radius: 0.25rem;
        padding: 0;
        display: flex;
        align-items: center;
        box-sizing: border-box;
        overflow: hidden;
    }
    
    #metadata-form .select2-container .select2-selection--single .select2-selection__rendered {
        padding-left: 0.5rem;
        padding-right: 0.5rem;
        line-height: 29px; /* 31px - 2px border */
        font-size: 0.875rem;
        color: #212529;
        overflow: hidden;
        text-overflow: ellipsis;
        white-space: nowrap;
    }
    
    #metadata-form .select2-container .select2-selection--single .select2-selection__arrow {
        height: 29px;
        right: 0.5rem;
    }
    
    /* Input group sizing */
    #metadata-form .input-group-sm > .form-control,
    #metadata-form .input-group-sm > .input-group-text {
        height: 31px;
        padding: 0.25rem 0.5rem;
        font-size: 0.875rem;
        line-height: 1.5;
    }
    
    /* Button sizing */
    #metadata-form .btn-sm {
        height: 31px;
        padding: 0.25rem 0.5rem;
        font-size: 0.875rem;
        line-height: 1.5;
        width: 100%;
    }
</style>

<div class="card bg-light border-0 mb-3">
    <div class="card-body py-2">
        <div class="row g-2 align-items-center">
             <!-- Worksheets & Raw Data (Edit Form) -->
             <div class="col-lg-6 border-end pe-3">
                <form method="POST" enctype="multipart/form-data" novalidate id="edit-datatable-form">
                    {{ edit_form.hidden_tag() }}
                    <div class="row g-2 align-items-center">
                        <div class="col">
                             <div class="input-group input-group-sm">
                                <span class="input-group-text bg-white border-end-0"><i class="fa-solid fa-link text-muted"></i></span>
                                {% if data_table.raw_data_url and (data_table.raw_data_url.startswith('http://') or data_table.raw_data_url.startswith('https://')) %}
                                    <a href="{{ data_table.raw_data_url }}" target="_blank" class="form-control form-control-sm border-start-0 text-truncate" title="{{ data_table.raw_data_url }}">{{ data_table.raw_data_url }}</a>
                                {% else %}
                                    {{ edit_form.raw_data_url(class="form-control form-control-sm border-start-0", placeholder=_('Raw Data URL')) }}
                                {% endif %}
                            </div>
                        </div>
                        <div class="col-auto">
                             <div class="btn-group btn-group-sm">
                                <button type="button" class="btn btn-outline-secondary" data-bs-toggle="modal" data-bs-target="#filesModal">
                                    <i class="fa-solid fa-paperclip"></i> <span class="badge text-bg-secondary ms-1">{{ data_table.files.count() }}</span>
                                </button>
                                {% if not is_read_only %}
                                <button type="button" class="btn btn-outline-success" id="add-file-btn" title="{{_('Upload New File')}}">
                                    <i class="fa-solid fa-plus"></i>
                                </button>
                                {% endif %}
                            </div>
                        </div>
                         <div style="display: none;">
                            {{ edit_form.files(class="form-control form-control-sm", multiple=True, id="worksheet-files-input") }}
                        </div>
                    </div>
                </form>
             </div>
             
             <!-- Excel Import (Upload Form) -->
             <div class="col-lg-6 ps-3">
                 {% if is_read_only %}
                    <span class="text-muted small w-100 text-center d-block">{{ _('Read-only: No import') }}</span>
                 {% else %}
                 <div class="d-flex align-items-center justify-content-end gap-2">
                     <form method="POST" enctype="multipart/form-data" novalidate class="d-flex align-items-center">
                        {{ upload_form.hidden_tag() }}
                        <div class="input-group input-group-sm">
                             {{ upload_form.file(class="form-control form-control-sm") }}
                             <button type="submit" name="submit_upload" value="True" class="btn btn-primary">
                                <i class="fas fa-file-import"></i> {{ _('Import Data') }}
                             </button>
                        </div>
                         <span class="ms-2 text-muted" data-bs-toggle="tooltip" data-bs-placement="top" title="{{ _('Upload an Excel (.xlsx, .xls) or CSV file to update existing data. The file must contain an ID column to match animals. Only columns corresponding to protocol analytes will be updated.') }}">
                            <i class="fas fa-info-circle"></i>
                        </span>
                     </form>
                     {% if data_table.protocol.enable_import_wizard %}
                     <button type="button" class="btn btn-outline-primary btn-sm" data-bs-toggle="modal" data-bs-target="#importWizardModal" title="{{ _('Import Wizard - Advanced formatting and assignment') }}">
                         <i class="fas fa-magic"></i> {{ _('Wizard') }}
                     </button>
                     {% endif %}
                 </div>
                 {% endif %}
             </div>
        </div>
    </div>
</div>
<hr class="my-3">

<!-- Controlled Molecules Section -->
{% if controlled_molecules_data %}
<div class="card border-0 mb-3">
    <div class="card-header bg-white py-2 border-bottom">
        <h6 class="m-0 font-weight-bold text-primary">{{ _('Controlled Molecules Usage') }}</h6>
    </div>
    <div class="card-body p-2">
        <div class="accordion" id="moleculesAccordion">
            {% for item in controlled_molecules_data %}
            {% set molecule = item.molecule %}
            {% set form = item.form %}
            {% set usages = item.usages %}

            <div class="card mb-1">
                <div class="card-header py-1 px-3" id="headingMol{{ molecule.id }}">
                    <h2 class="mb-0">
                        <button class="btn btn-link btn-block text-start text-decoration-none p-0 d-flex justify-content-between align-items-center w-100" type="button" data-bs-toggle="collapse"
                            data-bs-target="#collapseMol{{ molecule.id }}" aria-expanded="true"
                            aria-controls="collapseMol{{ molecule.id }}">
                            <span class="d-flex align-items-center">
                                <strong class="text-dark">{{ molecule.name }}</strong>
                                <span class="badge bg-secondary ms-2 small" style="font-size: 0.7rem;">{{ molecule.regulation_category.value }}</span>
                            </span>
                            <span class="text-muted small">{{ _('Record Usage') }} <i class="fas fa-chevron-down ms-1"></i></span>
                        </button>
                    </h2>
                </div>

                <div id="collapseMol{{ molecule.id }}" class="collapse" aria-labelledby="headingMol{{ molecule.id }}"
                    data-bs-parent="#moleculesAccordion">
                    <div class="card-body p-3">
                        <!-- Usage Recording Form -->
                        <form method="POST" action="{{ url_for('datatables.edit_data_table', id=data_table.id) }}"
                            class="mb-3">
                            {{ form.hidden_tag() }}
                            <input type="hidden" name="submit_molecule_usage" value="1">
                            <input type="hidden" name="molecule_id" value="{{ molecule.id }}">
                            <script nonce="{{ csp_nonce }}">
                                document.addEventListener('DOMContentLoaded', function () {
                                    const formField = document.getElementById('{{ form.molecule_id.id }}');
                                    if (formField) formField.value = '{{ molecule.id }}';
                                });
                            </script>
                            <input type="hidden" id="group_id" value="{{ data_table.group_id }}">

                            <div class="form-row">
                                <div class="form-group col-md-4">
                                    {{ render_field(form.volume_used, class="form-control") }}
                                    {% if molecule.unit %}
                                    <small class="text-muted">{{ _('Unit') }}: {{ molecule.unit }}</small>
                                    {% endif %}
                                </div>
                                <div class="form-group col-md-8">
                                    {{ render_field(form.notes, class="form-control") }}
                                </div>
                            </div>

                            <!-- Custom Animal Selection UI -->
                            <div class="form-group mt-3">
                                <label>{{ _('Select Animals (treated)') }}</label>
                                <div id="animal-selection-container-{{ molecule.id }}"
                                    class="border p-3 animal-selection-container"
                                    style="max-height: 200px; overflow-y: auto;"
                                    data-target-field="{{ form.animal_ids.id }}">
                                    <!-- JS will populate checkboxes here -->
                                    <p class="text-muted small">Loading animals...</p>
                                </div>
                                {{ form.animal_ids(id=form.animal_ids.id) }}
                                <small id="num-animals-display-{{ form.animal_ids.id }}" class="form-text text-muted">0
                                    animals
                                    selected</small>
                            </div>

                            <button type="submit" class="btn btn-primary mt-3">{{ _('Record Usage') }}</button>
                        </form>

                        <hr>

                        <!-- Usage History for this Molecule in this DataTable -->
                        <h6>{{ _('Usage History in this Table') }}</h6>
                        <div class="table-responsive">
                            <table class="table table-bordered table-sm">
                                <thead>
                                    <tr>
                                        <th>{{ _('Date') }}</th>
                                        <th>{{ _('Volume') }}</th>
                                        <th>{{ _('Animals') }}</th>
                                        <th>{{ _('Recorded By') }}</th>
                                        <th>{{ _('Notes') }}</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    {% if usages %}
                                    {% for usage in usages %}
                                    <tr>
                                        <td>{{ usage.recorded_at.strftime('%Y-%m-%d %H:%M') }}</td>
                                        <td>{{ usage.volume_used }}</td>
                                        <td>{{ usage.number_of_animals }} / {{ usage.animal_ids|length }}</td>
                                        <td>{{ usage.recorded_by.email if usage.recorded_by else _('Unknown') }}
                                        </td>
                                        <td>{{ usage.notes }}</td>
                                    </tr>
                                    {% endfor %}
                                    {% else %}
                                    <tr>
                                        <td colspan="5" class="text-center text-muted">{{ _('No usage recorded
                                            yet.') }}</td>
                                    </tr>
                                    {% endif %}
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>
            </div>
            {% endfor %}
        </div>
    </div>
</div>
{% endif %}



<!-- MODAL for File Management -->
<div class="modal fade" id="filesModal" tabindex="-1" aria-labelledby="filesModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-lg modal-dialog-centered">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="filesModalLabel">{{ _('Manage Uploaded Files') }}</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                {% if data_table.files.all() %}
                <ul class="list-group">
                    {% for file in data_table.files %}
                    <li class="list-group-item d-flex justify-content-between align-items-center">
                        <a href="{{ url_for('datatables.view_data_table_file', id=data_table.id, file_id=file.id) }}"
                            target="_blank">{{ file.filename }}</a>
                        <form method="POST"
                            action="{{ url_for('datatables.delete_data_table_file', id=data_table.id, file_id=file.id) }}"
                            class="confirm-delete-form" style="display:inline;">
                            <input type="hidden" name="csrf_token" value="{{ csrf_token() }}" />
                            <button type="submit" class="btn btn-sm btn-outline-danger" title="{{ _('Delete file') }}">
                                <i class="fa-solid fa-trash"></i>
                            </button>
                        </form>
                    </li>
                    {% endfor %}
                </ul>
                {% else %}
                <p class="text-muted">{{ _('No files have been uploaded yet.') }}</p>
                {% endif %}
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">{{ _('Close') }}</button>
            </div>
        </div>
    </div>
</div>

<div class="row">
    <div class="col-md-12">
        <form method="POST">
            <input type="hidden" name="csrf_token" value="{{ csrf_token() }}" />
            <div class="table-responsive">
                <table class="table table-bordered table-striped table-hover" id="data-table-edit">
                    <thead class="table-light">
                        <tr>
                            {% for col_name in column_names %}
                            <th data-column-name="{{ col_name }}"
                                class="{% if col_name in metadata_fields %}metadata-col{% endif %}">
                                {{ col_name }}
                                {% if col_name in protocol_field_units and protocol_field_units[col_name] %}
                                <span class="text-muted small">({{ protocol_field_units[col_name] }})</span>
                                {% endif %}
                            </th>
                            {% endfor %}
                        </tr>
                    </thead>
                    <tbody>
                        {% for row_item in template_data %}
                        <tr>
                            {% set row_index = row_item.row_index %}
                            {% set current_row_data = row_item.row_data %}
                            {% for col_name in column_names %}
                            {% set col_index = loop.index0 %}
                            <td data-column-name="{{ col_name }}"
                                class="{% if col_name in metadata_fields %}metadata-col{% endif %}">
                                {% set is_readonly_structural = col_name in animal_model_field_names or col_name == 'Age
                                (Days)' %}
                                {% set is_calculated = col_name in calculated_fields %}

                                <div class="position-relative h-100">
                                    <input type="{{ 'date' if col_name in date_fields else 'text' }}"
                                        class="form-control form-control-sm border-0 h-100 rounded-0 cell-input {% if is_readonly_structural or is_calculated %}bg-light text-muted{% endif %}"
                                        name="cell_{{ row_index }}_{{ col_index }}"
                                        value="{{ current_row_data.get(col_name, '') }}" style="min-width: 80px;" {% if
                                        is_readonly_structural or is_read_only or is_calculated %}readonly tabindex="-1"
                                        {% endif %} {% if is_calculated %}title="{{ _('Calculated Field') }}" {% endif
                                        %}>
                                    {% if is_calculated %}
                                    <span class="position-absolute top-0 end-0 p-1 text-muted"
                                        style="font-size: 0.6rem; pointer-events: none;">
                                        <i class="fas fa-calculator"></i>
                                    </span>
                                    {% endif %}
                                </div>
                            </td>
                            {% endfor %}
                        </tr>
                        {% endfor %}
                        {% if num_rows == 0 %}
                        <tr>
                            <td colspan="{{ column_names|length }}" class="text-center text-muted">{{ _('No rows defined
                                for this experimental group.') }}</td>
                        </tr>
                        {% endif %}
                    </tbody>
                </table>
            </div>
            {% if not is_read_only %}
            <button type="submit" name="submit_grid" class="btn btn-primary mt-3">{{ _('Save Changes') }}</button>
            {% endif %}
            <button type="button" id="toggle-metadata" class="btn btn-secondary mt-3">{{ _('Show Metadata') }}</button>
        </form>
        <hr>
        <!-- Protocol Details Modal -->
        <div class="modal fade" id="protocolDetailsModal" tabindex="-1" aria-labelledby="protocolDetailsModalLabel"
            aria-hidden="true">
            <div class="modal-dialog">
                <div class="modal-content">
                    <div class="modal-header">
                        <h5 class="modal-title" id="protocolDetailsModalLabel">{{ _('Protocol Details') }}: {{
                            data_table.protocol.name }}</h5>
                        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                    </div>
                    <div class="modal-body">
                        {% if data_table.protocol.description %}
                        <p><strong>{{ _('Description:') }}</strong></p>
                        <p>{{ data_table.protocol.description }}</p>
                        {% else %}
                        <p class="text-muted">{{ _('No description provided.') }}</p>
                        {% endif %}

                        <p><strong>{{ _('Severity:') }}</strong> {{ data_table.protocol.severity.value }}</p>

                        <hr>

                        {% if data_table.protocol.url %}
                        <p><strong>{{ _('Reference URL:') }}</strong></p>
                        <p><a href="{{ data_table.protocol.url }}" target="_blank">{{ data_table.protocol.url }}</a></p>
                        {% else %}
                        <p class="text-muted">{{ _('No reference URL provided.') }}</p>
                        {% endif %}

                        <hr>

                        {% if data_table.protocol.attachments.first() %}
                        {% set attachment = data_table.protocol.attachments.first() %}
                        <p><strong>{{ _('Attachment:') }}</strong></p>
                        <p>
                            <a href="{{ url_for('core_models.download_protocol_attachment', protocol_id=data_table.protocol.id, attachment_id=attachment.id) }}"
                                class="btn btn-sm btn-success">
                                <i class="fas fa-download"></i> {{ attachment.filename }}
                            </a>
                        </p>
                        {% else %}
                        <p class="text-muted">{{ _('No attachment provided.') }}</p>
                        {% endif %}
                    </div>
                    <div class="modal-footer">
                        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">{{ _('Close')
                            }}</button>
                    </div>
                </div>
            </div>
        </div>
        
        {% if data_table.protocol.enable_import_wizard %}
        <!-- Import Wizard Modal -->
        <div class="modal fade" id="importWizardModal" tabindex="-1" aria-labelledby="importWizardModalLabel" aria-hidden="true">
            <div class="modal-dialog modal-xl modal-dialog-centered">
                <div class="modal-content">
                    <div class="modal-header bg-primary text-white">
                        <h5 class="modal-title" id="importWizardModalLabel"><i class="fa-solid fa-file-import me-2"></i>{{ _('Import Raw Data Assistant') }}</h5>
                        <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Close"></button>
                    </div>
                    <div class="modal-body">
                        <!-- Stepper -->
                        <div class="row mb-4">
                            <div class="col-12">
                                <div class="d-flex justify-content-between step-indicator">
                                    <div class="step active" id="step-1-indicator">1. {{ _('Upload') }}</div>
                                    <div class="step" id="step-2-indicator">2. {{ _('Mapping') }}</div>
                                    <div class="step" id="step-3-indicator">3. {{ _('Validation') }}</div>
                                    <div class="step" id="step-4-indicator">4. {{ _('Confirm') }}</div>
                                </div>
                            </div>
                        </div>

                        <!-- Step 1: Upload -->
                        <div class="import-step" id="step-1">
                            <h5>{{ _('Step 1: Upload Raw Data File') }}</h5>
                            <p class="text-muted">{{ _('Supported formats: CSV, XLSX, XLS, TXT, JSON') }}</p>
                            <div class="mb-3">
                                <label for="import-file" class="form-label">{{ _('Choose File') }}</label>
                                <input class="form-control" type="file" id="import-file">
                            </div>

                            <div class="mb-3">
                                <button class="btn btn-sm btn-outline-secondary" type="button" data-bs-toggle="collapse" data-bs-target="#advanced-parse-options">
                                    <i class="fas fa-cog"></i> {{ _('Advanced Parsing Options') }}
                                </button>
                                <div class="collapse mt-2" id="advanced-parse-options">
                                    <div class="card card-body bg-light shadow-sm border-0">
                                        <div class="row">
                                            <div class="col-md-6 mb-2">
                                                <label class="form-label small fw-bold">{{ _('Rows to skip') }}</label>
                                                <input type="number" id="import-skip-rows" class="form-control form-control-sm" value="0" min="0">
                                            </div>
                                            <div class="col-md-6 mb-2">
                                                <label class="form-label small fw-bold">{{ _('Data anchor text') }}</label>
                                                <input type="text" id="import-anchor-text" class="form-control form-control-sm" placeholder="{{ _('e.g. [DATA]') }}">
                                                <small class="text-muted d-block" style="font-size: 0.7rem;">{{ _('Skips all lines until this text is found.') }}</small>
                                            </div>
                                            <div class="col-md-6 mb-2">
                                                <label class="form-label small fw-bold">{{ _('Anchor Offset') }}</label>
                                                <input type="number" id="import-anchor-offset" class="form-control form-control-sm" value="0">
                                                <small class="text-muted d-block" style="font-size: 0.7rem;">{{ _('X rows to skip AFTER the anchor.') }}</small>
                                            </div>
                                            <div class="col-md-6 mb-2">
                                                <label class="form-label small fw-bold">{{ _('Row Interval') }}</label>
                                                <input type="number" id="import-row-interval" class="form-control form-control-sm" value="1" min="1">
                                                <small class="text-muted d-block" style="font-size: 0.7rem;">{{ _('Import every Xth row (e.g. 11 for skip 10).') }}</small>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>

                            <div class="mb-3 d-none" id="pipeline-selection-container">
                                <label class="form-label fw-bold">{{ _('Use Import Pipeline (Script)') }}</label>
                                <select id="import-pipeline-select" class="form-select">
                                    <option value="">-- No Pipeline --</option>
                                    <!-- Options populated by JS -->
                                </select>
                                <small class="text-muted">{{ _('Selecting a pipeline will bypass manual mapping and use a custom script to parse the file.') }}</small>
                            </div>

                            <div class="mb-3">
                                <div class="d-flex justify-content-between align-items-center mb-1">
                                    <label class="form-label fw-bold">{{ _('Select Mapping Template (Optional)') }}</label>
                                    <div>
                                        <button class="btn btn-xs btn-outline-primary" type="button" id="import-template-btn">
                                            <i class="fas fa-file-import"></i> {{ _('Import from JSON') }}
                                        </button>
                                        <input type="file" id="template-file-input" class="d-none" accept=".json">
                                    </div>
                                </div>
                                <select id="import-template-select" class="form-select">
                                    <option value="">-- New Mapping --</option>
                                    <!-- Options populated by JS -->
                                </select>
                            </div>
                        </div>

                        <!-- Step 2: Mapping -->
                        <div class="import-step d-none" id="step-2">
                            <div class="d-flex justify-content-between align-items-center mb-2">
                                <h5>{{ _('Step 2: Map Columns & Formulas') }}</h5>
                                <div class="d-flex gap-2">
                                    <button class="btn btn-xs btn-outline-secondary" type="button" id="export-template-btn" title="{{ _('Export as portable JSON') }}">
                                        <i class="fas fa-file-export"></i> {{ _('Export JSON') }}
                                    </button>
                                    <button class="btn btn-xs btn-outline-info" type="button" data-bs-toggle="collapse" data-bs-target="#import-help-guide">
                                        <i class="fas fa-question-circle"></i> {{ _('Help Guide') }}
                                    </button>
                                </div>
                            </div>

                            <div class="collapse mb-3" id="import-help-guide">
                                <div class="card card-body bg-light small shadow-sm border-0">
                                    <h6><i class="fas fa-info-circle text-primary"></i> {{ _('Advanced Logic Guide') }}</h6>
                                    <p class="mb-2">{{ _('You can enter Python formulas in the <code>f(x)=</code> fields. Use <code>x</code> as the placeholder for the raw value.') }}</p>
                                    <div class="row">
                                        <div class="col-md-6">
                                            <ul class="mb-0">
                                                <li><strong>{{ _('Math') }}:</strong> <code>x * 10</code>, <code>abs(x)</code>, <code>round(x, 2)</code></li>
                                                <li><strong>{{ _('Limits') }}:</strong> <code>max(0, x)</code>, <code>min(100, x)</code></li>
                                            </ul>
                                        </div>
                                        <div class="col-md-6">
                                            <ul class="mb-0">
                                                <li><strong>{{ _('Advanced') }}:</strong> <code>math.log10(x)</code>, <code>math.sqrt(x)</code></li>
                                                <li><strong>{{ _('Constants') }}:</strong> <code>math.pi</code>, <code>math.e</code></li>
                                            </ul>
                                        </div>
                                    </div>
                                </div>
                            </div>

                            <div class="table-responsive" style="max-height: 400px;">
                                <table class="table table-sm table-bordered">
                                    <thead class="table-light">
                                        <tr>
                                            <th>{{ _('File Column Header') }}</th>
                                            <th>{{ _('Map to Analyte') }}</th>
                                            <th>{{ _('Preview Data') }}</th>
                                        </tr>
                                    </thead>
                                    <tbody id="mapping-table-body">
                                        <!-- Populated by JS -->
                                    </tbody>
                                </table>
                            </div>
                            <div class="mt-3">
                                <div class="form-check">
                                    <input class="form-check-input" type="checkbox" id="save-as-template">
                                    <label class="form-check-label" for="save-as-template">
                                        {{ _('Save this mapping as a new template') }}
                                    </label>
                                </div>
                                <div id="template-name-container" class="mt-2 d-none">
                                    <input type="text" id="new-template-name" class="form-control form-control-sm" placeholder="{{ _('Template Name') }}">
                                </div>
                            </div>
                        </div>

                        <!-- Step 3: Validation -->
                        <div class="import-step d-none" id="step-3">
                            <h5>{{ _('Step 3: Animal ID Validation') }}</h5>
                            <div id="validation-results">
                                <div class="alert alert-info">
                                    <i class="fas fa-spinner fa-spin me-2"></i>{{ _('Validating animal IDs...') }}
                                </div>
                            </div>
                        </div>

                        <!-- Step 4: Confirm -->
                        <div class="import-step d-none" id="step-4">
                            <h5>{{ _('Step 4: Final Confirmation') }}</h5>
                            <div class="alert alert-warning">
                                <i class="fas fa-exclamation-triangle me-2"></i>
                                {{ _('Important: This will overwrite any existing data for the matched animals in this datatable. This action will be logged in the audit trail.') }}
                            </div>
                            <p id="import-summary-text"></p>
                        </div>
                    </div>
                    <div class="modal-footer">
                        <button type="button" class="btn btn-secondary" id="import-prev-btn" disabled>{{ _('Previous') }}</button>
                        <button type="button" class="btn btn-primary" id="import-next-btn">{{ _('Next') }}</button>
                        <button type="button" class="btn btn-success d-none" id="import-finalize-btn">{{ _('Import Now') }}</button>
                    </div>
                </div>
            </div>
        </div>

        <style nonce="{{ csp_nonce }}">
            /* Force Select2 to match form-control-sm height */
            .select2-container .select2-selection--single {
                height: 31px !important;
                padding: 2px 8px; /* Standard sm padding */
                display: flex;
                align-items: center;
                border: 1px solid #ced4da; /* Ensure border matches */
            }
            .select2-container--bootstrap-5 .select2-selection {
                font-size: 0.875rem;
            }
            /* Match input-group height exactly */
            .input-group-sm > .form-control,
            .input-group-sm > .input-group-text,
            .input-group-sm > .btn {
                 height: 31px !important;
            }
            .step-indicator {
                position: relative;
                padding-bottom: 10px;
                border-bottom: 2px solid #e9ecef;
            }
            .step {
                font-weight: bold;
                color: #6c757d;
                flex: 1;
                text-align: center;
                position: relative;
            }
            .step.active {
                color: #0d6efd;
            }
            .step.active::after {
                content: '';
                position: absolute;
                bottom: -12px;
                left: 0;
                width: 100%;
                height: 4px;
                background-color: #0d6efd;
            }
            .btn-xs {
                padding: 1px 5px;
                font-size: 0.75rem;
            }
        </style>
        {% endif %}
        {% endblock %}

        {% block scripts %}
        {{ super() }}
        <!-- Configuration Object for JS -->
        <script type="application/json" id="datatable-editor-config" nonce="{{ csp_nonce }}">
{
    "dataTableId": {{ data_table.id | tojson }},
    "protocolId": {{ data_table.protocol.id | tojson }},
    "groupId": {{ data_table.group.id | tojson }},
    "i18n": {
        "selectHousing": "{{ _('Select Housing Conditions') }}",
        "unassigned": "{{ _('Unassigned') }}",
        "showMetadata": "{{ _('Show Metadata') }}",
        "hideMetadata": "{{ _('Hide Metadata') }}",
        "confirmDelete": "{{ _('Are you sure you want to delete this file?') }}"
    },
    "animalData": {{ animals_dataset | tojson | safe }}
}
</script>

        <!-- Load the external JS files -->
        <script src="{{ url_for('static', filename='js/datatables_edit.js') }}" nonce="{{ csp_nonce }}"></script>
        <script src="{{ url_for('static', filename='js/import_wizard.js') }}" nonce="{{ csp_nonce }}"></script>
        <script src="{{ url_for('static', filename='js/controlled_molecules.js') }}" nonce="{{ csp_nonce }}"></script>
        {% endblock %}