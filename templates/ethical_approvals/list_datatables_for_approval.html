{# templates/ethical_approvals/list_datatables_for_approval.html #}
{% extends "base.html" %}

{% block title %}{{ title }}{% endblock %}

{% block content %}
    <h1>{{ title }}</h1>
    <p>
        <strong>{{ _('Approval Title:') }}</strong> {{ approval.title }}<br>
        <strong>{{ _('Reference:') }}</strong> {{ approval.reference_number }}
    </p>

    <div class="d-flex justify-content-between align-items-center mb-3">
        <a href="{{ url_for('ethical_approvals.list_ethical_approvals') }}" class="btn btn-secondary">
            <i class="fas fa-arrow-left"></i> {{ _('Back to All Ethical Approvals') }}
        </a>
        
        {% if available_years %}
        <form method="GET" id="yearFilterForm" action="{{ url_for('ethical_approvals.list_datatables_for_ethical_approval', ethical_approval_id=approval.id) }}" class="d-flex align-items-center">
            <div class="me-2">
                <label for="yearFilter" class="form-label visually-hidden">{{ _('Filter by Year') }}</label>
                <select name="year" id="yearFilter" class="form-select">
                    <option value="">{{ _('All Years') }}</option>
                    {% for year in available_years %}
                        <option value="{{ year }}" {% if year == selected_year %}selected{% endif %}>{{ year }}</option>
                    {% endfor %}
                </select>
            </div>
            {% if selected_year %}
                <a href="{{ url_for('ethical_approvals.list_datatables_for_ethical_approval', ethical_approval_id=approval.id) }}" class="btn btn-outline-secondary">{{ _('Clear') }}</a>
            {% endif %}
        </form>
        {% endif %}
    </div>

    <h3 class="mt-4">{{ _('DataTables Linked to this Approval (via Experimental Groups)') }}</h3>

    {% if datatables %}
        <div class="table-responsive">
            <table id="linkedDataTablesTableEA" class="table table-striped table-hover table-bordered" style="width:100%;">
                <thead>
                    <tr>
                        <th>{{ _('Group Name') }}</th>
                        <th>{{ _('Protocol') }}</th>
                        <th>{{ _('Protocol Severity') }}</th>
                        <th>{{ _('Date') }}</th>
                        <th class="text-center">{{ _('Animals') }}</th>
                        <th>{{ _('Actions') }}</th>
                    </tr>
                </thead>
                <tbody>
                    {% for dt in datatables %}
                    <tr class="{{ 'table-secondary text-muted' if dt.group.is_archived or (dt.group.project and dt.group.project.is_archived) else '' }}">
                        <td>
                            <a href="{{ url_for('groups.edit_group', id=dt.group.id) }}">{{ dt.group.name if dt.group else _('N/A') }}</a>
                            {% if dt.group and dt.group.is_archived %}<span class="badge bg-warning text-dark ms-1">{{ _('Group Archived') }}</span>{% endif %}
                        </td>
                        <td>{{ dt.protocol.name if dt.protocol else _('N/A') }}</td>
                        <td>
                            {% if dt.protocol and dt.protocol.severity %}
                                {{ dt.protocol.severity.value }}
                            {% else %}
                                {{ _('N/A') }}
                            {% endif %}
                        </td>
                        <td>{{ dt.date }}</td>
                        <td class="text-center">{{ dt.animal_count }}</td>
                        <td>
                            <a href="{{ url_for('datatables.view_data_table', datatable_id=dt.id) }}" class="btn btn-sm btn-outline-info" title="{{ _('View DataTable') }}"><i class="fas fa-eye"></i></a>
                            <a href="{{ url_for('datatables.edit_data_table', id=dt.id) }}" class="btn btn-sm btn-outline-primary" title="{{ _('Edit DataTable') }}"><i class="fas fa-edit"></i></a>
                        </td>
                    </tr>
                    {% endfor %}
                </tbody>
            </table>
        </div>
    {% else %}
        <p class="alert alert-info">{{ _('No DataTables are currently linked to this ethical approval (via its groups) that you have permission to view.') }}</p>
    {% endif %}
{% endblock %}

{% block scripts %}
    {{ super() }}
    <script nonce="{{ csp_nonce }}">
        $(document).ready(function() {
            $('#linkedDataTablesTableEA').DataTable({ // Unique ID for this table
                "language": {
                    "search": "{{ _('Search:') }}",
                    "lengthMenu": "{{ _('Show _MENU_ entries') }}",
                    "info": "{{ _('Showing _START_ to _END_ of _TOTAL_ entries') }}",
                    "infoEmpty": "{{ _('Showing 0 to 0 of 0 entries') }}",
                    "infoFiltered": "{{ _('(filtered from _MAX_ total entries)') }}",
                    "paginate": {
                        "first": "{{ _('First') }}",
                        "last": "{{ _('Last') }}",
                        "next": "{{ _('Next') }}",
                        "previous": "{{ _('Previous') }}"
                    }
                },
                "columnDefs": [
                    { "orderable": false, "targets": 5 }, // Actions column
                    { "className": "text-center", "targets": [4] } 
                ],
                "order": [[3, "desc"]] 
            });

            $('#yearFilter').on('change', function() {
                $('#yearFilterForm').submit();
            });
        });
    </script>
{% endblock %}