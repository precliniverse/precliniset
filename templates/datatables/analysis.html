{# templates/datatables/analysis.html #}
{% extends "base.html" %}
{% import "datatables/analysis/_macros.html" as macros %}

{% block title %}{{ _('Analysis') }}{% if data_table %} - {{ data_table.group.name }} - {{ data_table.protocol.name }}{%
endif %}{% endblock %}

{% block content %}
{# Alpine.js Config Container #}
{% set numerical_json = numerical_columns | tojson | safe %}
{% set categorical_json = categorical_columns | tojson | safe %}
<div id="analysis-config" data-form-data='{{ form_data | tojson | safe }}' data-numerical-columns='{{ numerical_json }}'
    data-categorical-columns='{{ categorical_json }}' data-numerical-debug='{{ numerical_columns | list | length }}'
    data-categorical-debug='{{ categorical_columns | list | length }}' style="display: none;">
</div>

<script nonce="{{ csp_nonce }}">
    window.CONFIG = {
        datatableId: {{ data_table.id if data_table else 'null' }},
    analysisStage: '{{ analysis_stage }}',
        formData: {{ form_data | tojson | safe }},
    urls: {
        analysisStatus: "{{ url_for('datatables.analysis_status', task_id='TASK_ID') }}",
            availableRanges: "{{ url_for('reference_ranges.available_reference_ranges', datatable_id=data_table.id) if data_table else '' }}"
    },
    numericalColumns: {{ numerical_json }},
    categoricalColumns: {{ categorical_json }}
    };
</script>

<div class="container-fluid py-4" x-data="analysisManager()" x-cloak
    data-has-analysis-results="{% if analysis_results %}true{% else %}false{% endif %}">
    {# Page Header #}
    <div class="d-flex justify-content-between align-items-center mb-4">
        <div>
            {% if data_table %}
            <h1 class="h3 mb-0">{{ _('Analysis: %(group)s', group=data_table.group.name) }}</h1>
            {% if analysis_stage != 'show_results' %}
            <p class="text-muted small mb-0">
                <i class="fas fa-table me-1"></i>
                {{ _('DataTable: %(protocol)s (%(date)s)', protocol=data_table.protocol.name, date=data_table.date) }}
            </p>
            {% endif %}
            {% elif source_identifiers %}
            <h1 class="h3 mb-0">{{ analysis_page_title or _('Merged Analysis') }}</h1>
            {% if analysis_stage != 'show_results' %}
            <div class="mt-2 text-muted small">
                <span class="me-2">{{ _('Source Data:') }}</span>
                {% for identifier in source_identifiers %}
                <span class="badge bg-body-tertiary text-body border fw-normal">{{ identifier }}</span>
                {% endfor %}
            </div>
            {% endif %}
            {% else %}
            <h1 class="h3 mb-0">{{ _('Analysis') }}</h1>
            {% endif %}
        </div>
    </div>

    {# Main Form #}
    <form id="analysis-form" method="POST"
        action="{{ url_for('datatables.analyze_datatable', datatable_id=data_table.id) if data_table else url_for('datatables.analyze_selected_datatables') }}">
        <input type="hidden" name="csrf_token" value="{{ csrf_token() }}">
        {% if not data_table and form_data.get('selected_datatable_ids') %}
        {% for dt_id in form_data.get('selected_datatable_ids') %}
        <input type="hidden" name="selected_datatable_ids[]" value="{{ dt_id }}">
        {% endfor %}
        {% endif %}

        {# Global Stage Input (Fixes Step 2 loop loop) #}
        <input type="hidden" name="analysis_stage" id="analysis_stage" value="{{ analysis_stage }}">

        {# Partials #}
        {% include "datatables/analysis/_form_stage1.html" %}
        {% include "datatables/analysis/_form_stage2.html" %}
        {% include "datatables/analysis/_results_stage3.html" %}
    </form>
</div>
{% endblock %}

{% block scripts %}
{# Alpine.js Components loaded in base.html #}
<script src="{{ url_for('static', filename='js/analysis/api.js') }}?v=1" nonce="{{ csp_nonce }}"></script>
<script src="{{ url_for('static', filename='js/analysis/manager.js') }}?v=1" nonce="{{ csp_nonce }}"></script>
<script src="{{ url_for('static', filename='js/analysis/plots.js') }}?v=1" nonce="{{ csp_nonce }}"></script>
<script src="{{ url_for('static', filename='js/analysis/export.js') }}?v=1" nonce="{{ csp_nonce }}"></script>
{% endblock %}