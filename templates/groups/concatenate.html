{% extends 'base.html' %}

{% block title %}{{ _('Concatenation & Analysis') }} - {{ group.name }}{% endblock %}

{% block content %}
<div class="container mt-4">
    <div class="d-flex justify-content-between align-items-center mb-4">
        <h1>
            <i class="fas fa-chart-line me-2"></i>{{ _('Concatenation & Analysis') }}
            <small class="text-muted fs-5">| {{ group.name }}</small>
        </h1>
        <a href="{{ url_for('groups.edit_group', id=group.id) }}" class="btn btn-secondary">
            <i class="fas fa-arrow-left me-1"></i> {{ _('Back to Group') }}
        </a>
    </div>

    <div class="row">
        <!-- Sidebar: Configuration -->
        <div class="col-md-3">
            <div class="card mb-4">
                <div class="card-header">
                    <h5 class="mb-0">{{ _('Configuration') }}</h5>
                </div>
                <div class="card-body">
                    <p class="text-muted small mb-3">
                        {{ _('Select analytes to concatenate from all DataTables linked to this group in chronological
                        order.') }}
                    </p>

                    <div class="mb-3">
                        <label for="analyte-selector" class="form-label fw-bold">{{ _('Select Analytes') }}</label>
                        <select id="analyte-selector" class="form-select" multiple size="10">
                            <!-- Populated by JS -->
                        </select>
                        <div class="form-text">{{ _('Hold Ctrl/Cmd to select multiple.') }}</div>
                    </div>

                    <button type="button" class="btn btn-primary w-100" id="load-concatenation-btn">
                        <i class="fas fa-sync me-1"></i> {{ _('Load Data') }}
                    </button>

                    <hr>

                    <button type="button" class="btn btn-outline-primary w-100 mb-2" id="export-concatenated-btn"
                        disabled>
                        <i class="fas fa-file-excel me-1"></i> {{ _('Export to Excel') }}
                    </button>
                </div>
            </div>
        </div>

        <!-- Main Content: Results -->
        <div class="col-md-9">

            <!-- Global Measurement Tools -->
            <div class="card mb-4" id="global-measurement-tools-card" style="display: none;">
                <div class="card-header bg-light">
                    <h6 class="mb-0"><i class="fas fa-ruler-combined me-2"></i>{{ _('Global Measurement Tools') }}</h6>
                </div>
                <div class="card-body">
                    <div class="row g-3 align-items-end">
                        <div class="col-md-4">
                            <label for="global-measurement-select" class="form-label">{{ _('Measurement to Add')
                                }}</label>
                            <select id="global-measurement-select" class="form-select">
                                <option value="">{{ _('Select...') }}</option>
                                <option value="weight_change_abs">{{ _('Weight Change (Absolute)') }}</option>
                                <option value="weight_change_pct">{{ _('Weight Change (%%)') }}</option>
                                <option value="bmi">{{ _('BMI (Weight/Height²)') }}</option>
                                <option value="tumor_volume">{{ _('Tumor Volume (L×W²/2)') }}</option>
                            </select>
                        </div>
                        <div class="col-md-8" id="global-tool-params">
                            <!-- Dynamic inputs for tool parameters -->
                        </div>
                    </div>
                </div>
            </div>


            <!-- Graphs -->
            <div class="card mb-4" id="graph-container" style="display: none;">
                <div class="card-header d-flex justify-content-between align-items-center">
                    <h5 class="mb-0">{{ _('Evolution Graph') }}</h5>
                    <div class="form-check form-switch">
                        <input class="form-check-input" type="checkbox" id="group-by-treatment-switch" checked>
                        <label class="form-check-label" for="group-by-treatment-switch">{{ _('Group by Treatment')
                            }}</label>
                    </div>
                </div>
                <div class="card-body">
                    <canvas id="evolution-chart" style="max-height: 400px;"></canvas>
                </div>
            </div>

            <!-- Data Table -->
            <div class="card" id="concatenated-data-container" style="display: none;">
                <div class="card-header">
                    <h5 class="mb-0">{{ _('Concatenated Data') }}</h5>
                </div>
                <div class="card-body">
                    <div class="table-responsive">
                        <table class="table table-sm table-bordered table-striped" id="concatenated-data-table">
                            <thead>
                                <tr id="concatenated-table-header">
                                    <!-- Populated by JS -->
                                </tr>
                            </thead>
                            <tbody id="concatenated-table-body">
                                <!-- Populated by JS -->
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>

            <!-- Placeholder State -->
            <div id="concatenation-placeholder" class="text-center py-5 text-muted">
                <i class="fas fa-chart-line fa-3x mb-3"></i>
                <p class="lead">{{ _('Select analytes and load data to visualize results.') }}</p>
            </div>

        </div>
    </div>
</div>

{% set config_dict = {
"groupId": group.id,
"csrfToken": csrf_token(),
"urls": {
"getConcatenatedAnalytes": url_for("groups.get_concatenated_analytes_for_group", group_id=group.id),
"exportConcatenated": url_for("groups.export_concatenated_analytes", group_id=group.id)
},
"i18n": {
"loading": _("Loading..."),
"error": _("Error"),
"noData": _("No data available")
}
} %}
<script id="page-config" type="application/json" data-config='{{ config_dict | tojson | safe }}'></script>

{% endblock %}

{% block scripts %}
{{ super() }}
<script src="https://cdn.jsdelivr.net/npm/chart.js@3.9.1/dist/chart.min.js"></script>
<script
    src="https://cdn.jsdelivr.net/npm/chartjs-adapter-date-fns@2.0.0/dist/chartjs-adapter-date-fns.bundle.min.js"></script>
<script type="module" src="{{ url_for('static', filename='js/groups/concatenate_page.js') }}"></script>
{% endblock %}